// Generated by CoffeeScript 1.8.0
(function() {
  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  window.CardDetailPopup = (function() {
    function CardDetailPopup(page) {
      this.showCard = __bind(this.showCard, this);
      var onLinkClick, t;
      t = this;
      this.cardname = null;
      this.cardset = null;
      this.loadToken = 0;
      this.loadingTag = $('<p />', {
        'text': 'Nahrávám ...'
      });
      this.errorTag = $('<p />', {
        'text': 'Kartu nelze zobrazit'
      });
      this.popup = new Popup();
      onLinkClick = function(e) {
        var cardname, cardset, l;
        e.preventDefault();
        l = $(this);
        cardname = l.data('cardname');
        cardset = l.data('cardset');
        if (cardname !== t.cardname || cardset !== t.cardset) {
          t.cardname = cardname;
          t.cardset = cardset;
          return t.showCard(cardname, cardset);
        } else {
          return t.popup.show();
        }
      };
      page.on('resultsLoaded', (function(_this) {
        return function(e, list) {
          return $('.detail-button', list).on('click', onLinkClick);
        };
      })(this));
    }

    CardDetailPopup.prototype.showCard = function(cardname, cardset) {
      this.cardname = cardname;
      this.cardset = cardset;
      this.popup.setContent(this.loadingTag);
      this.popup.show();
      return $.when(this.loadCard(++this.loadToken, this.cardname)).then(null, (function(_this) {
        return function() {
          return _this.popup.setContent(_this.errorTag);
        };
      })(this));
    };

    CardDetailPopup.prototype.loadCard = function(token, name) {
      var encName, img, p;
      p = new $.Deferred();
      encName = encodeURIComponent(name.trim());
      img = $('<img />').load((function(_this) {
        return function() {
          if (token === _this.loadToken) {
            _this.popup.setContent(img);
          }
          return p.resolve();
        };
      })(this)).error((function(_this) {
        return function() {
          return p.reject();
        };
      })(this)).attr('src', 'http://gatherer.wizards.com/Handlers/Image.ashx?type=card&name=' + encName);
      return p.promise();
    };

    return CardDetailPopup;

  })();

}).call(this);
